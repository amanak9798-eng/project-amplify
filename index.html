<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Amplify</title>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* --- Base Setup --- */
        :root {
            --primary-color: #0a66c2;
            --background-color: #f3f2ef; /* LinkedIn's light grey background */
            --container-bg: #ffffff;
            --text-primary: #191919;
            --text-secondary: #65676b;
            --border-color: #dce1e6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            padding-top: 80px; /* Space for the fixed header */
        }

        /* --- New Header Bar --- */
        .app-header {
            width: 100%;
            background-color: var(--container-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 10%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            height: 60px;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .cta-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.7rem 1.4rem;
            border-radius: 2rem; /* Pill shape */
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .cta-button:hover {
            background-color: #004182;
        }
        .account-actions {
            position: relative;
            display: flex;
            align-items: center;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 10px);
            background-color: var(--container-bg);
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-weight: 500;
        }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .account-actions:hover .dropdown-content { display: block; }

        /* --- Main App Container --- */
        .app-container {
            width: 100%;
            max-width: 740px;
            margin: 40px auto;
            padding: 2.5rem;
            box-sizing: border-box;
            background-color: var(--container-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* --- Hero Section & GIF --- */
        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }
        .hero-section h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        .hero-section .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem auto;
        }
        .gif-container {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            background-color: #e2e8f0; /* Placeholder color */
        }
        .gif-container img {
            width: 100%;
            display: block;
        }
        
        /* --- Input & Generate Button --- */
        .input-area textarea {
            width: 100%;
            height: 120px;
            padding: 1rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            resize: vertical;
            box-sizing: border-box;
        }
        .generate-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border-radius: 6px;
            border: none;
            color: white;
            background-color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .generate-button:hover {
            background-color: #004182;
        }
        .generate-button:active {
            transform: scale(0.98);
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }
        .generate-button.loading .spinner { display: block; }
        .generate-button.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- New Results Section & Card --- */
        .results-section {
            margin-top: 3rem;
            display: none;
        }
        .results-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }
        .results-actions {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.8rem;
        }
        .action-btn {
            padding: 0.8rem 1.2rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .action-btn.primary {
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }
        .action-btn.primary:hover {
            background-color: #004182;
            border-color: #004182;
        }
        .action-btn.secondary {
            background-color: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .action-btn.secondary:hover {
            background-color: #f0f2f5;
        }
        .action-btn svg {
            width: 18px;
            height: 18px;
        }
        .action-btn.icon-btn {
            padding: 0.8rem;
        }

        /* --- Footer --- */
        .app-footer {
            text-align: center;
            padding: 4rem 0 2rem 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .app-footer a {
            color: var(--text-secondary);
            text-decoration: none;
            margin: 0 10px;
        }
        .app-footer a:hover {
            text-decoration: underline;
        }
        
        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        .modal-content.auth, .modal-content.premium {
            max-width: 450px;
            text-align: center;
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: none;
        }
        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            width: 100%;
            padding: 0.8rem;
            background-color: #ffffff;
            color: #333;
            border: 1px solid #ccd0d5;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .google-btn:hover { background-color: #f7f7f7; }
        .google-btn img { width: 20px; height: 20px; }
        .divider { margin: 1.5rem 0; color: #8a8d91; }
        .auth-form input, .automation-form input, .automation-form select {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #ccd0d5;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .auth-buttons { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .auth-buttons button { flex-grow: 1; }
        #auth-error { color: #d93025; margin-top: 1rem; min-height: 1.2em; }
        .history-item {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .history-title {
            padding: 1rem;
            font-weight: bold;
            cursor: pointer;
            background-color: #f7f7f7;
            transition: background-color 0.2s ease;
        }
        .history-title:hover { background-color: #e9e9e9; }
        .history-content {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: none;
        }
        .history-item.active .history-content { display: block; }
        .automation-form .time-selection { display: flex; gap: 1rem; }
        .schedule-item { border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 1rem; overflow: hidden; }
        .schedule-title { padding: 1rem; font-weight: bold; background-color: #f7f7f7; }
        .user-badge {
            background-color: #0d824d; /* Green for premium */
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            margin-right: 1rem;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo">Project Amplify</div>
        <div class="account-actions">
            <span class="user-badge">Premium</span>
            <button id="cta-button" class="cta-button">Sign Up</button>
            <div id="account-dropdown" class="dropdown-content">
                <a href="#" id="historyBtn-dropdown">History</a>
                <a href="#" id="automationBtn-dropdown">Automation</a>
                <a href="#" id="signOutBtn-dropdown">Sign Out</a>
            </div>
        </div>
    </header>

    <main class="app-container">
        <div class="hero-section">
            <h1>The Fastest Way from Idea to Impact on LinkedIn.</h1>
            <p class="subtitle">Stop staring at a blank screen. Turn your fleeting thoughts into powerful, professional posts in seconds. See it in action below.</p>
            <div class="gif-container">
                <img src="https://placehold.co/600x338/e2e8f0/cccccc?text=Animated+Demo+Here" alt="Animated demo of Project Amplify" title="Your animated GIF will go here!">
            </div>
        </div>

        <div class="input-area">
            <textarea id="ideaInput" placeholder="Start with a simple idea... e.g., 'the impact of remote work on company culture in India'"></textarea>
            <button class="generate-button" id="generateBtn">
                <span class="btn-text">✨ Generate Post</span>
                <div class="spinner"></div>
            </button>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-card">
                <div class="post-content" id="postContent"></div>
                <div class="results-actions">
                    <button id="copyBtn" class="action-btn primary">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"></path></svg>
                        Copy Post
                    </button>
                    <button id="retryBtn" class="action-btn secondary">Retry</button>
                    <button id="saveBtn" class="action-btn secondary icon-btn" title="Save to History">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="app-footer">
        <p>
            <a href="#" id="termsLink">Terms of Service</a> |
            <a href="#" id="privacyLink">Privacy Policy</a> |
            <a href="#" id="creatorLink">From the Creator</a>
        </p>
    </footer>

    <!-- MODALS -->
    <div id="auth-modal" class="modal">
        <div class="modal-content auth">
            <button class="close-btn" data-modal="auth-modal">&times;</button>
            <header>
                <h2>Create an Account to Continue</h2>
                <p>Join for free to start generating AI-powered posts.</p>
            </header>
            <div class="auth-form">
                <button id="googleSignInBtn" class="google-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                    Sign in with Google
                </button>
                <p class="divider">or</p>
                <input type="email" id="emailInput" placeholder="Email">
                <input type="password" id="passwordInput" placeholder="Password">
                <div class="auth-buttons">
                    <button id="signUpBtn" class="generate-button action-btn primary">Sign Up</button>
                    <button id="loginBtn" class="action-btn secondary">Log In</button>
                </div>
                <p id="auth-error"></p>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" data-modal="history-modal">&times;</button>
            <h2>Your Post History</h2>
            <div id="history-list"></div>
        </div>
    </div>
    
    <div id="automation-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" data-modal="automation-modal">&times;</button>
            <h2>Automation</h2>
            <p>Set up a schedule to automatically generate posts on a topic.</p>
            <div class="automation-form">
                <h3>Create New Schedule</h3>
                <input type="text" id="automationTopic" placeholder="Enter a topic (e.g., weekly AI news)">
                <div class="time-selection">
                    <select id="automationFrequency">
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                    <select id="automationDay">
                        <option value="1">on Monday</option>
                        <option value="2">on Tuesday</option>
                        <option value="3">on Wednesday</option>
                        <option value="4">on Thursday</option>
                        <option value="5">on Friday</option>
                        <option value="6">on Saturday</option>
                        <option value="0">on Sunday</option>
                    </select>
                    <select id="automationTime">
                        <option value="09:00">at 09:00 AM</option>
                        <option value="12:00">at 12:00 PM</option>
                        <option value="15:00">at 03:00 PM</option>
                        <option value="18:00">at 06:00 PM</option>
                    </select>
                </div>
                <button id="saveScheduleBtn" class="generate-button" style="margin-top: 1rem;">Save Schedule</button>
            </div>
            <hr style="margin: 2rem 0;">
            <h3>Your Active Schedules</h3>
            <div id="schedule-list"></div>
        </div>
    </div>
    
    <div id="premium-modal" class="modal">
        <div class="modal-content premium">
            <button class="close-btn" data-modal="premium-modal">&times;</button>
            <h2>Unlock Automation</h2>
            <p>Go premium to put your content on autopilot and save hours every week.</p>
            <div style="margin: 2rem 0; font-size: 2.5rem; font-weight: bold; color: var(--primary-color);">
                ₹299 <span style="font-size: 1rem; font-weight: normal;">/ month</span>
            </div>
            <button id="subscribeBtn" class="generate-button">Subscribe Now</button>
        </div>
    </div>
    
    <!-- ========= FIREBASE SCRIPT (MODULE) ========= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- 1. PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
           apiKey: "AIzaSyBbR8i9p3OdSFqgFznTrcrSAdRoZd6JCyM",
           authDomain: "project-amplify-f3d8b.firebaseapp.com",
           projectId: "project-amplify-f3d8b",
           storageBucket: "project-amplify-f3d8b.firebasestorage.app",
           messagingSenderId: "944323887163",
           appId: "1:944323887163:web:dca950ea7032ae776adc1e"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Element References ---
        const ctaButton = document.getElementById('cta-button');
        const historyBtnDropdown = document.getElementById('historyBtn-dropdown');
        const automationBtnDropdown = document.getElementById('automationBtn-dropdown');
        const signOutBtnDropdown = document.getElementById('signOutBtn-dropdown');
        
        const authModal = document.getElementById('auth-modal');
        const historyModal = document.getElementById('history-modal');
        const automationModal = document.getElementById('automation-modal');
        const premiumModal = document.getElementById('premium-modal');

        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const signUpBtn = document.getElementById('signUpBtn');
        const loginBtn = document.getElementById('loginBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const authError = document.getElementById('auth-error');
        const historyList = document.getElementById('history-list');

        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        const scheduleList = document.getElementById('schedule-list');
        const automationTopic = document.getElementById('automationTopic');
        const automationFrequency = document.getElementById('automationFrequency');
        const automationDay = document.getElementById('automationDay');
        const automationTime = document.getElementById('automationTime');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const userBadge = document.querySelector('.user-badge');

        let isPremiumUser = false;

        // --- Auth State Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                ctaButton.innerText = "My Account";
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                isPremiumUser = docSnap.exists() && docSnap.data().isPremium;
                if(isPremiumUser) {
                    userBadge.style.display = 'inline-block';
                } else {
                    userBadge.style.display = 'none';
                }
            } else {
                ctaButton.innerText = "Sign Up";
                isPremiumUser = false;
                userBadge.style.display = 'none';
            }
        });

        // --- Event Listeners for Header & Modals ---
        historyBtnDropdown.addEventListener('click', (e) => { e.preventDefault(); displayHistory(); });
        automationBtnDropdown.addEventListener('click', (e) => { 
            e.preventDefault(); 
            if(isPremiumUser) {
                automationModal.style.display = 'flex';
                displaySchedules();
            } else {
                premiumModal.style.display = 'flex';
            }
        });
        signOutBtnDropdown.addEventListener('click', async (e) => { e.preventDefault(); await signOut(auth); });
        
        ctaButton.addEventListener('click', () => { 
            if (!auth.currentUser) { authModal.style.display = 'flex'; }
        });

        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById(btn.dataset.modal).style.display = 'none';
            });
        });
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // --- Authentication Functions ---
        signUpBtn.addEventListener('click', async () => {
            authError.innerText = '';
            try {
                await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                authModal.style.display = 'none';
            } catch (error) { authError.innerText = error.message; }
        });
        loginBtn.addEventListener('click', async () => {
            authError.innerText = '';
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                authModal.style.display = 'none';
            } catch (error) { authError.innerText = error.message; }
        });
        googleSignInBtn.addEventListener('click', async () => {
            authError.innerText = '';
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                authModal.style.display = 'none';
            } catch (error) { authError.innerText = error.message; }
        });
    
        // --- History Function ---
        async function displayHistory() {
            const user = auth.currentUser;
            if (!user) {
                authModal.style.display = 'flex';
                return;
            }
            historyList.innerHTML = 'Loading history...';
            historyModal.style.display = 'flex';

            const postsRef = collection(db, 'users', user.uid, 'posts');
            const q = query(postsRef, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            historyList.innerHTML = '';
            if (querySnapshot.empty) {
                historyList.innerHTML = '<p>You have no saved posts yet.</p>';
            } else {
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('history-item');
                    itemElement.innerHTML = `
                        <div class="history-title">${post.title}</div>
                        <div class="history-content">
                            <p>${post.content}</p>
                            <small>Generated on: ${post.createdAt ? post.createdAt.toDate().toLocaleString() : 'Just now'}</small>
                        </div>
                    `;
                    itemElement.addEventListener('click', () => itemElement.classList.toggle('active'));
                    historyList.appendChild(itemElement);
                });
            }
        }

        // --- Automation Schedule Functions ---
        saveScheduleBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const topic = automationTopic.value.trim();
            if (!topic) return alert("Please enter a topic.");
            
            const schedule = {
                userId: user.uid,
                topic: topic,
                frequency: automationFrequency.value,
                dayOfWeek: automationDay.value,
                time: automationTime.value,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'users', user.uid, 'schedules'), schedule);
                automationTopic.value = '';
                displaySchedules();
            } catch (error) { console.error("Error saving schedule:", error); }
        });

        async function displaySchedules() {
            const user = auth.currentUser;
            if (!user) return;
            scheduleList.innerHTML = 'Loading schedules...';
            
            const schedulesRef = collection(db, 'users', user.uid, 'schedules');
            const q = query(schedulesRef, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            scheduleList.innerHTML = '';
            if (querySnapshot.empty) {
                scheduleList.innerHTML = '<p>You have no active schedules.</p>';
            } else {
                const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                querySnapshot.forEach((doc) => {
                    const schedule = doc.data();
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('schedule-item');
                    itemElement.innerHTML = `
                        <div class="schedule-title">
                            <strong>Topic:</strong> ${schedule.topic}<br>
                            <small><strong>Schedule:</strong> Every ${dayNames[schedule.dayOfWeek]} at ${schedule.time}</small>
                        </div>`;
                    scheduleList.appendChild(itemElement);
                });
            }
        }

        // --- Razorpay Payment Logic ---
        subscribeBtn.addEventListener('click', async () => {
            subscribeBtn.disabled = true;
            subscribeBtn.innerText = "Processing...";
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("Please log in to subscribe.");
                }
                const keyId = document.getElementById('razorpay-key-id').value;
                if (keyId === "YOUR_RAZORPAY_KEY_ID") {
                    throw new Error("Razorpay Key ID is not configured.");
                }
                const orderResponse = await fetch('/api/create-order', { method: 'POST' });
                if (!orderResponse.ok) {
                    throw new Error("Could not create payment order from server.");
                }
                const orderData = await orderResponse.json();
                const options = {
                    key: keyId,
                    amount: orderData.amount,
                    currency: orderData.currency,
                    name: "Project Amplify Premium",
                    description: "Monthly Subscription",
                    order_id: orderData.id,
                    handler: async function (response) {
                        try {
                            const verificationResponse = await fetch('/api/verify-payment', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    order_id: orderData.id,
                                    razorpay_signature: response.razorpay_signature,
                                    userId: user.uid
                                })
                            });
                            const verificationData = await verificationResponse.json();
                            if (verificationResponse.ok && verificationData.msg === "Payment verified successfully") {
                                alert("Payment successful! You are now a premium member.");
                                premiumModal.style.display = 'none';
                                isPremiumUser = true;
                                userBadge.style.display = 'inline-block';
                            } else {
                                throw new Error("Payment verification failed.");
                            }
                        } catch (verifyError) {
                            alert("Payment verification failed. Please contact support.");
                            console.error("Verification Error:", verifyError);
                        }
                    },
                    prefill: { name: user.displayName || "", email: user.email },
                    theme: { color: "#0a66c2" }
                };
                const rzp1 = new Razorpay(options);
                rzp1.open();
                rzp1.on('payment.failed', function (response){
                    alert("Payment failed: " + response.error.description);
                });
            } catch (error) {
                alert("An error occurred: " + error.message);
                console.error("Subscription Error:", error);
            } finally {
                subscribeBtn.disabled = false;
                subscribeBtn.innerText = "Subscribe Now";
            }
        });

        // Export services for the other script
        window.firebaseServices = { auth, db, serverTimestamp, collection, addDoc };
    </script>
    
    <!-- ========= MAIN APP LOGIC ========= -->
    <script>
        const generateBtn = document.getElementById('generateBtn');
        const ideaInput = document.getElementById('ideaInput');
        const resultsSection = document.getElementById('resultsSection');
        const postContent = document.getElementById('postContent');
        const copyBtn = document.getElementById('copyBtn');
        const retryBtn = document.getElementById('retryBtn');
        const saveBtn = document.getElementById('saveBtn');
        
        const SECURE_API_URL = '/api/generate';

        async function generatePost() {
            const { auth } = window.firebaseServices;
            if (!auth.currentUser) {
                document.getElementById('auth-modal').style.display = 'flex'; 
                return; 
            }
            if (ideaInput.value.trim() === '') {
                alert("Please enter an idea first!");
                return;
            }

            generateBtn.classList.add('loading');
            generateBtn.disabled = true;
            generateBtn.querySelector('.btn-text').innerText = "Generating...";

            try {
                const response = await fetch(SECURE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idea: ideaInput.value })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || "An error occurred.");
                
                postContent.innerText = data.post;
                resultsSection.style.display = 'block';
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
                generateBtn.querySelector('.btn-text').innerText = "✨ Generate Post";
            }
        }

        generateBtn.addEventListener('click', generatePost);
        retryBtn.addEventListener('click', generatePost);
        
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(postContent.innerText).then(() => {
                const originalContent = copyBtn.innerHTML;
                copyBtn.innerText = "Copied!";
                setTimeout(() => {
                    copyBtn.innerHTML = originalContent;
                }, 1500);
            });
        });
        
        saveBtn.addEventListener('click', () => {
            const { auth, db, serverTimestamp, collection, addDoc } = window.firebaseServices;
            const user = auth.currentUser;
            if (!user) {
                alert("Sign up for a free account to save posts!");
                document.getElementById('auth-modal').style.display = 'flex';
                return;
            }
            
            const generatedText = postContent.innerText;
            const userIdea = ideaInput.value;
            const postTitle = userIdea.substring(0, 60) + (userIdea.length > 60 ? '...' : '');

            addDoc(collection(db, 'users', user.uid, 'posts'), {
                userId: user.uid,
                title: postTitle,
                content: generatedText,
                originalIdea: userIdea,
                createdAt: serverTimestamp()
            }).then(() => {
                alert("Post saved to your history!");
            }).catch(err => {
                console.error("Error saving post:", err);
                alert("Could not save post. Please try again.");
            });
        });
    </script>
    <input type="hidden" id="razorpay-key-id" value="rzp_test_RV76TlaBfMsY85">
</body>
</html>

